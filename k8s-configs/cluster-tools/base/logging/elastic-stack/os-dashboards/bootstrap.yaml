apiVersion: batch/v1
kind: Job
metadata:
  name: os-dash-bootstrap
  annotations:
     argocd.argoproj.io/sync-options: Replace=true
     argocd.argoproj.io/hook: Sync
     argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  template:
    spec:
      serviceAccountName: enrichment
      containers:
        - name: os-dash-bootstrap
          image: public.ecr.aws/r2h3l6e4/pingcloud-monitoring/enrichment-bootstrap/dev:v1.18-release-branch-latest
          imagePullPolicy: Always
          workingDir: /scripts
          command: [ "sh", '$(CONTAINER_NAME).sh' ]
          env:
            - name: CONTAINER_NAME
              value: 'os-dash-bootstrap'
            - name: OS_DASH_URL
              value: 'http://opensearch-dashboards'
            - name: OS_DASH_PORT
              value: '5601'
            - name: CHECK_OS_DASH_URL
              value: "http://opensearch-dashboards:5601/api/status"
            - name: CHECK_OPENSEARCH_URL
              value: "https://opensearch-cluster-master:9200/_cluster/health"
            - name: RETRY_OS_DASH_BOOTSTRAP_SEC
              value: "30"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
          volumeMounts:
            - name: os-dashboards-pd
              mountPath: /scripts/dashboards/pd
            - name: os-dashboards-pf
              mountPath: /scripts/dashboards/pf
            - name: enrichment-opensearch-index-templates
              mountPath: /scripts/index-templates
          resources:
            requests:
              memory: "256Mi"
              cpu: "300m"
            limits:
              memory: "512Mi"
              cpu: "500m"
      restartPolicy: OnFailure
      volumes:
        - name: enrichment-opensearch-index-templates
          configMap:
            name: enrichment-opensearch-index-templates
        - name: os-dashboards-pd
          configMap:
            name: os-dashboards-pd
        - name: os-dashboards-pf
          configMap:
            name: os-dashboards-pf
